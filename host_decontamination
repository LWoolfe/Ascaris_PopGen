#!/bin/bash
#SBATCH --job-name=deacon_deplete
#SBATCH --output=/parallel_scratch/lw01165/02_Samples/logs/deacon_deplete_%j.out
#SBATCH --error=/parallel_scratch/lw01165/02_Samples/logs/deacon_deplete_%j.err
#SBATCH --cpus-per-task=16
#SBATCH --mem=32G
#SBATCH --time=24:00:00

set -euo pipefail

# -------- paths --------
REFDIR="/parallel_scratch/lw01165/01_Reference/deacon_human_pig"
IDX="${REFDIR}/human_pig_genome.idx"

BASEDIR="/parallel_scratch/lw01165/02_Samples"
IN_DIR="${BASEDIR}/samples_fastp"
LOGDIR="${BASEDIR}/decon_logs"
mkdir -p "${LOGDIR}"

# Your required sample list
SAMPLE_LIST="${BASEDIR}/sample.ids.txt"

# Use parallel scratch for temp
export TMPDIR="${BASEDIR}/tmp_deacon_${SLURM_JOB_ID:-local}"
mkdir -p "$TMPDIR"

THREADS=${SLURM_CPUS_PER_TASK:-8}

# -------- env --------
source /users/lw01165/miniconda3/etc/profile.d/conda.sh
conda activate deacon

command -v deacon >/dev/null || { echo "âŒ deacon not found in PATH"; exit 1; }
[[ -s "$IDX" ]] || { echo "âŒ Index not found: $IDX"; exit 1; }
[[ -s "$SAMPLE_LIST" ]] || { echo "âŒ Sample list not found: $SAMPLE_LIST"; exit 1; }

echo "==> Host: $(hostname)"
echo "==> Using index: $IDX"
echo "==> Using sample list: $SAMPLE_LIST"
echo "==> Input dir:  $IN_DIR"
echo "==> TMPDIR:     $TMPDIR"
echo "==> Threads:    $THREADS"
echo "==> Start:      $(date)"

# -------- run one sample --------
run_one() {
  local sample="$1"

  local r1="${IN_DIR}/${sample}_trimmed_R1.fq.gz"
  local r2="${IN_DIR}/${sample}_trimmed_R2.fq.gz"

  local o1="${IN_DIR}/${sample}_decon_R1.fq.gz"
  local o2="${IN_DIR}/${sample}_decon_R2.fq.gz"
  local js="${IN_DIR}/${sample}_deacon_summary.json"

  # sanity checks
  if [[ ! -s "$r1" || ! -s "$r2" ]]; then
    echo "âŒ [$sample] missing input(s): $r1 or $r2"
    return 0
  fi

  # skip if completed
  if [[ -s "$o1" && -s "$o2" ]]; then
    echo "âœ… [$sample] decontam outputs already exist â€” skipping"
    return 0
  fi

  echo "ðŸš€ [$sample] running deacon filter..."

  deacon filter -d "$IDX" "$r1" "$r2" \
      -o "$o1" -O "$o2" \
      -s "$js" \
      --threads "$THREADS"

  echo "ðŸ [$sample] finished"
}

# -------- main loop --------
while IFS= read -r raw; do
  sample="$(echo "$raw" | sed 's/[[:space:]]*$//')"  # trim whitespace

  [[ -z "$sample" ]] && continue
  [[ "$sample" =~ ^# ]] && continue

  {
    run_one "$sample"
  } 2>&1 | tee -a "${LOGDIR}/${sample}_deacon_${SLURM_JOB_ID:-noslurm}.log"

done < "$SAMPLE_LIST"

echo "âœ… All samples processed at $(date)"
