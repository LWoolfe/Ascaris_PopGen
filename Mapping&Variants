# Analysis of population structure of Ascaris sp.  

## Table of contents
0. [Project overview](#overview)
1. [Project setup](#setup)
2. [Raw data](#raw)
3. [Mapping](#mapping)
4. [Variant calling](#variantcalling)
5. [Quality control](#qc)

## 00 - Project overview

The aim of this work is to analyse the population structure Ascaris sp. using publicly available WGS reads and newly synthesised data across diverse geographical regions and from both human and porcine hosts. 

## 01 - Project setup 
### Setup a working environment for the analysis.
mkdir Pop_gen
cd Pop_gen

# make working directories
mkdir 00_METADATA 01-reference 02-raw_sequences 03-mapping 04-variants 05-QC 06-analysis
```
## 02-raw_sequences
# Download publicly available WGS reads using SRA toolkit

# Trim and perform fastqc on all data 

fastp 
fast qc 
multiqc

cd 01_REFERENCES
# Download the A. suum reference genome on ncbi using SRA Toolkit 
prefetch GCA_013433145.1

# Validate the downloaded genome 
vdb-validate GCA_013433145.1

# Unzip
gunzip GCA_013433145.1_ASM1343314V1_genomic.fa.gz

#Ensure that GCA_013433145.1_ASM1343314v1_assembly_report.txt was downloaded then create a list of primary scaffolds
#Check headers are correct
grep -v "^#" GCA_013433145.1_ASM1343314v1_assembly_report.txt | head
grep -v "^#" GCA_013433145.1_ASM1343314v1_assembly_report.txt \
  | awk -F '\t' '$2 == "assembled-molecule" && ($1 ~ /^chr[0-9]+$/ || $1 == "chrX") {print $5}' \
  > scaffolds_primary_plus_X.txt

# Exclude unmapped scaffolds (include only primary scaffolds)
seqtk subseq genome.fna scaffolds_primary_plus_X.txt > Ascaris_primary_scaffolds_plus_X.fasta

# Create indexes and a sequence dictionary for the reference genome
bwa index Ascaris_primary_scaffolds_plus_X.fasta
samtools faidx Ascaris_primary_scaffolds_plus_X.fasta
gatk CreateSequenceDictionary --REFERENCE Ascaris_primary_scaffolds_plus_X.fasta

# Check all primary scaffolds are present
grep -v "^#" GCA_013433145.1_ASM1343314v1_assembly_report.txt \
  | awk -F '\t' '$2 == "assembled-molecule" && $1 ~ /^chr[0-9]+$/ {print $1}' \
  | wc -l
wc -l scaffolds_primary.txt

## 03 - Mapping 
### Map sequence reads to reference genome

cd 03-mapping

./mapping.sh

#!/bin/bash
THREADS=6
# Directories
REF_DIR="01-reference"
READS_DIR="02-raw_reads"
OUT_DIR="03-mapping"
REF_GENOME="${REF_DIR}/Ascaris_primary_scaffolds_plus_X.fasta"
mkdir -p "$OUT_DIR"

# Loop through all R1 reads
for R1 in ${READS_DIR}/*_trimmed_R1.fq.gz; do
    SAMPLE=$(basename "$R1" _trimmed_R1.fq.gz)
    R2="${READS_DIR}/${SAMPLE}_trimmed_R2.fq.gz"

    echo "Processing sample: $SAMPLE"

    bwa mem -t "$THREADS" "$REF_GENOME" "$R1" "$R2" \
        | samtools sort -@"$THREADS" -o "${OUT_DIR}/${SAMPLE}.bam" -
done


### Mark PCR duplicates
```
parallel --dry-run --colsep '\t' "gatk MarkDuplicates --INPUT {1}.bam --OUTPUT {1}.markdup.bam --METRICS_FILE {1}.metrics.txt" :::: <(cat ${WORKING_DIR}/00_METADATA/suppdata.txt | grep "gz" | cut -f1)
```
The parallel command will write each markduplicate command to screen, this will create a MarkDuplicates command with set arguments to run separately or as a batch on cluster. It will name the output bam file with the sample name example:
```
gatk MarkDuplicates --INPUT {$samplenumber}.bam --OUTPUT {$samplenumber}.markdup.bam --METRICS_FILE {$samplenumber}.metrics.txt

# Index all BAM files
parallel -j1 --colsep '\t' "samtools index {1}.markdup.bam" <(cat ${WORKING_DIR}/00_METADATA/suppdata.txt | grep "gz")
